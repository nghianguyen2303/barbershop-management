<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>C·∫≠p nh·∫≠t L·ªãch h·∫πn</title>

    <style>
        body {
            font-family: Arial;
            background: #f4f4f4;
            padding: 20px;
        }

        .container {
            width: 480px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 10px #ccc;
        }

        h2 {
            text-align: center;
            color: #1976d2;
            margin-bottom: 20px;
        }

        label {
            margin-top: 12px;
            display: block;
            font-weight: bold;
        }

        input, select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #aaa;
            border-radius: 5px;
        }

        .dv-box {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            background: #fafafa;
            margin-bottom: 12px;
        }

        .alert-error {
            background: #ffe0e0;
            border: 1px solid #d40000;
            color: #b30000;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .busy {
            background: #ffcccc;
            font-weight: bold;
        }

        .free {
            background: #ccffcc;
            font-weight: bold;
        }

        button {
            margin-top: 20px;
            width: 100%;
            padding: 12px;
            background: #1976d2;
            border: none;
            color: white;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        a.button {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 14px;
            background: #1976d2;
            color: white;
            border-radius: 5px;
            text-decoration: none;
        }
    </style>
</head>

<body>

<div class="container"
     th:data-current-time="${lichHen.gioHen}"
     th:data-id="${lichHen.maLh}">
    <h2>C·∫≠p nh·∫≠t L·ªãch h·∫πn</h2>

    <div th:if="${errorMsg}" class="alert-error" th:text="${errorMsg}"></div>

    <form th:action="@{/user/lichhen/edit}" method="post" id="editForm">

        <input type="hidden" name="maLh" th:value="${lichHen.maLh}"/>

        <!-- Ng√†y -->
        <label>Ng√†y h·∫πn:</label>
        <input type="date" id="ngayHen" name="ngayHen"
               th:value="${lichHen.ngayHen}" required />

        <!-- Nh√¢n vi√™n -->
        <label>Nh√¢n vi√™n:</label>
        <select id="nhanVien" name="nhanVien" required>
            <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
            <option th:each="nv : ${listNhanVien}"
                    th:value="${nv.manv}"
                    th:text="${nv.hoTen}"
                    th:selected="${nv.manv == lichHen.nhanVien.manv}">
            </option>
        </select>

        <!-- D·ªãch v·ª• -->
        <label>D·ªãch v·ª•:</label>
        <div class="dv-box">
            <label th:each="dv : ${listDichVu}">
                <input type="checkbox"
                       class="dv-check"
                       name="dichVuChon"
                       th:value="${dv.maDv}"
                       th:checked="${selectedDvIds.contains(dv.maDv)}" />
                <span th:text="${dv.tenDv}"></span>
            </label>
        </div>

        <!-- Gi·ªù -->
        <label>Gi·ªù h·∫πn:</label>
        <select id="gioHen" name="gioHen" disabled required>
            <option value="">-- Ch·ªçn gi·ªù --</option>
        </select>

        <button type="submit">üíæ C·∫≠p nh·∫≠t l·ªãch h·∫πn</button>
    </form>

    <a href="/user/home" class="button">‚Üê Quay l·∫°i</a>
</div>

<script>
/* Normalize DB time (HH:mm:ss -> HH:mm) */
function normalizeTime(t) {
    if (!t) return '';
    return t.length >= 5 ? t.substring(0,5) : t;
}

/* Ki·ªÉm tra ƒëi·ªÅu ki·ªán b·∫≠t select gi·ªù */
function checkEnableTimeEdit() {
    const date = document.getElementById('ngayHen').value;
    const manv = document.getElementById('nhanVien').value;

    let dvCount = 0;
    document.querySelectorAll('.dv-check:checked').forEach(() => dvCount++);

    const select = document.getElementById('gioHen');

    if (date && manv && dvCount > 0) {
        select.disabled = false;
        loadTimeSlotsEdit();
    } else {
        select.disabled = true;
        select.innerHTML = '<option value="">-- Ch·ªçn gi·ªù --</option>';
    }
}

/* Load gi·ªù r·∫£nh/b·∫≠n, c√≥ excludeId ƒë·ªÉ b·ªè qua ch√≠nh l·ªãch ƒëang s·ª≠a */
async function loadTimeSlotsEdit() {
    const ngay = document.getElementById('ngayHen').value;
    const manv = document.getElementById('nhanVien').value;
    const maLh = document.querySelector('.container').dataset.id;
    if (!ngay || !manv) return;

    const currentTime = normalizeTime(document.querySelector('.container').dataset.currentTime || '');

    let dvIds = [];
    document.querySelectorAll('.dv-check:checked').forEach(cb => dvIds.push(cb.value));

    let url = `/user/lichhen/api/timeslots?manv=${manv}&ngay=${ngay}&excludeId=${maLh}`;
    dvIds.forEach(id => url += `&dvIds[]=${id}`);

    try {
        const res = await fetch(url);
        const data = await res.json();

        const select = document.getElementById('gioHen');
        select.innerHTML = '<option value="">-- Ch·ªçn gi·ªù --</option>';

        data.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.time;
            if (item.busy) {
                opt.textContent = `${item.time} (B·∫≠n)`;
                opt.disabled = true;
                opt.className = 'busy';
            } else {
                opt.textContent = item.time;
                opt.className = 'free';
            }

            if (item.time === currentTime) opt.selected = true;
            select.appendChild(opt);
        });
    } catch (e) {
        console.error('loadTimeSlotsEdit error', e);
    }
}

/* Event bindings */
document.getElementById('ngayHen').addEventListener('change', checkEnableTimeEdit);
document.getElementById('nhanVien').addEventListener('change', checkEnableTimeEdit);
document.querySelectorAll('.dv-check').forEach(cb => cb.addEventListener('change', checkEnableTimeEdit));

/* Khi m·ªü trang edit: ch·ªù DOM render xong, sau ƒë√≥ ki·ªÉm tra v√† load */
window.addEventListener('load', () => {
    // delay nh·ªè ƒë·ªÉ Thymeleaf ƒë√£ ƒë√°nh d·∫•u checked cho checkbox
    setTimeout(() => {
        checkEnableTimeEdit(); // s·∫Ω g·ªçi loadTimeSlotsEdit n·∫øu ƒë·ªß ƒëi·ªÅu ki·ªán
    }, 80);
});

/* Ch·∫∑n ch·ªânh s·ª≠a v·ªÅ qu√° kh·ª© */
document.getElementById('editForm').addEventListener('submit', function(e) {
    const d = document.getElementById('ngayHen').value;
    const t = document.getElementById('gioHen').value;
    if (!d || !t) return;
    const selected = new Date(d + 'T' + t);
    if (selected < new Date()) {
        e.preventDefault();
        alert('‚ùå Kh√¥ng th·ªÉ ch·ªânh s·ª≠a v·ªÅ qu√° kh·ª©!');
    }
});
</script>

</body>
</html>
